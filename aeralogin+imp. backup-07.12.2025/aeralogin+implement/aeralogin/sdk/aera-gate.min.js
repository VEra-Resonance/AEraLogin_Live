/**
 * AEra Gate SDK v1.0.0 (minified)
 * https://aeralogin.com | Apache-2.0 | ¬© 2025 VEra-Resonance
 */
!function(e){"use strict";const t={apiBase:"https://aeralogin.com",mode:"client",clientId:null,sessionCookieName:"aera_session",debug:!1};let n={...t},o=null;function a(...e){n.debug&&console.log("[AEraGate]",...e)}function i(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null}function s(e,t,n=1){const o=new Date(Date.now()+24*n*60*60*1e3).toUTCString();document.cookie=`${e}=${t}; expires=${o}; path=/; SameSite=Lax${"https:"===location.protocol?"; Secure":""}`}function r(e){document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`}async function c(){const e=i(n.sessionCookieName);if(!e)return a("No session token found"),null;if("secure"===n.mode)try{const t=await fetch(`${n.apiBase}/api/v1/verify`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),s=await t.json();return s.valid?(o={wallet:s.wallet,score:s.score,hasNFT:s.has_nft,expiresAt:s.expires_at},a("Session verified:",o),o):(a("Session invalid:",s.error),r(n.sessionCookieName),null)}catch(e){return a("Session verification error:",e),null}try{const t=JSON.parse(atob(e.split(".")[1]));return t.exp&&1e3*t.exp<Date.now()?(a("Token expired"),r(n.sessionCookieName),null):(o={wallet:t.sub,score:t.score,hasNFT:t.has_nft,expiresAt:new Date(1e3*t.exp).toISOString()},a("Session decoded (client mode):",o),o)}catch(e){return a("Token decode error:",e),r(n.sessionCookieName),null}}function l(e,t){const n=document.createElement("div");return n.className="aera-gate-denied",n.innerHTML=`<div class="aera-gate-box"><div class="aera-gate-icon">üîê</div><div class="aera-gate-title">Access Required</div><div class="aera-gate-text">${t.requireNFT?"Identity NFT required":""}${t.minScore>0?`<br>Minimum Score: ${t.minScore}`:""}</div><button class="aera-gate-button" onclick="AEraGate.login()">Continue with AEraLogIn</button></div>`,e.style.display="none",e.parentNode.insertBefore(n,e),n}function d(e){const t=e.previousSibling;t&&t.classList&&t.classList.contains("aera-gate-denied")&&t.remove(),e.style.display=""}async function u(e){const t=await c();return t?e.requireNFT&&!t.hasNFT?{allowed:!1,reason:"nft_required",session:t}:e.minScore&&t.score<e.minScore?{allowed:!1,reason:"score_too_low",session:t,required:e.minScore,actual:t.score}:{allowed:!0,session:t}:{allowed:!1,reason:"not_authenticated"}}const p={init:function(e={}){n={...t,...e},n.clientId||console.warn("[AEraGate] Warning: clientId not set."),a("Initialized with config:",n),document.getElementById("aera-gate-styles")||(e=document.createElement("style"),e.id="aera-gate-styles",e.textContent=".aera-gate-denied{padding:2rem;text-align:center;background:linear-gradient(135deg,#050814 0%,#0a0e27 100%);border-radius:16px;border:1px solid rgba(99,102,241,.3);color:#f0f4ff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}.aera-gate-box{max-width:400px;margin:0 auto}.aera-gate-icon{font-size:3rem;margin-bottom:1rem}.aera-gate-title{font-size:1.5rem;font-weight:700;margin-bottom:.5rem}.aera-gate-text{color:rgba(240,244,255,.7);margin-bottom:1.5rem;line-height:1.6}.aera-gate-button{background:linear-gradient(135deg,#0052ff,#6366f1);color:#fff;border:none;padding:.875rem 2rem;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s}.aera-gate-button:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,82,255,.4)}",document.head.appendChild(e)),this.autoProtect()},protect:async function(e={}){const t=e.selector||"[data-aera-protect]",n=document.querySelectorAll(t);a(`Protecting ${n.length} elements`);const o=await u({minScore:e.minScore||0,requireNFT:!1!==e.requireNFT});return n.forEach(t=>{const n=parseInt(t.dataset.minScore)||e.minScore||0,i=!1!==t.dataset.requireNft&&!1!==e.requireNFT,s={...o,allowed:o.allowed&&(!i||o.session?.hasNFT)&&(o.session?.score||0)>=n};s.allowed?(a("Access granted"),d(t),e.onAllow&&e.onAllow(s.session,t)):(a("Access denied:",s.reason),l(t,{minScore:n,requireNFT:i}),e.onDeny&&e.onDeny(s,t))}),o},autoProtect:async function(){document.querySelectorAll("[data-aera-protect]").length>0&&await this.protect({})},login:function(e={}){if(!n.clientId)return void console.error("[AEraGate] Cannot login: clientId not configured");const t=e.redirectUri||window.location.href.split("?")[0],o=(e=>{const t=new Uint8Array(16);return crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")})();sessionStorage.setItem("aera_oauth_state",o);const i=new URL(`${n.apiBase}/oauth/authorize`);i.searchParams.set("client_id",n.clientId),i.searchParams.set("redirect_uri",t),i.searchParams.set("response_type","code"),i.searchParams.set("state",o),a("Redirecting to:",i.toString()),window.location.href=i.toString()},handleCallback:async function(){const e=new URLSearchParams(window.location.search),t=e.get("code"),n=e.get("state");if(e.get("error"))return a("OAuth error"),null;if(!t)return a("No code"),null;const o=sessionStorage.getItem("aera_oauth_state");return n&&o&&n!==o?(console.error("[AEraGate] State mismatch"),null):(sessionStorage.removeItem("aera_oauth_state"),window.history.replaceState({},document.title,window.location.pathname),a("Code received"),await c())},logout:function(e={}){r(n.sessionCookieName),o=null,a("Session cleared"),e.redirectUrl?window.location.href=e.redirectUrl:window.location.reload()},getSession:c,checkAccess:u,version:"1.0.0"};e.AEraGate=p,"function"==typeof define&&define.amd&&define("AEraGate",[],function(){return p}),"object"==typeof module&&module.exports&&(module.exports=p),"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector("script[data-aera-client-id]");e&&p.init({clientId:e.dataset.aeraClientId,mode:e.dataset.aeraMode||"client",debug:"true"===e.dataset.aeraDebug})})}("undefined"!=typeof window?window:this);
